{% extends 'layout.html' %}
{% set active_page = 'watchlist' %}

{% block body %}
  {% include 'includes/_searchbar.html' %}

  {% raw %}
    <div id="vueapp">
      <div style="margin: 15px 0px 3px 3px;">
        <input type="checkbox" v-model="hideBlankLines" @change="hideShowListItems"> Hide media with no sources
        &nbsp; &nbsp;
        <input type="checkbox" v-model="hideAmzPayIcons" @change="hideShowListItems"> Hide Amazon pay sources
      </div>
      <div v-if="wlist.length == 0">
        <h3>Watchlist empty... search and add</h3>
      </div>
      <div v-else class="panel panel-default">
        <table class="table table-condensed table">
          <tr>
            <th class="col-md-1"></th>  <th class="col-md-4">Title</th>  <th class="col-md-4">Sources</th>  <th class="col-md-3"></th>
          </tr>
          <template v-for="w in wlist">
            <tr :class="sourceClasses(w)">
              <td v-if="w.mtype == 'show'">
                <a :href="w.mtype + '/id/' + w.id">
                  <img class="icon" src="static/glyphicon-tv.png" alt="tv icon" />
                </a>
              </td>
              <td v-else>
                <a :href="w.mtype + '/id/' + w.id">
                  <img class="icon" src="static/glyphicon-film.png" alt="film icon" />
                </a>
              </td>

              <td>{{ w.title }} ({{ w.year }})</td>

              <td>
                <span v-for="s in w.sources" :class="{amzPay: (s.name=='amazon_pay')}">
                  <a :href="s.link" target="_blank">
                    <img class="icon" :src="'static/' + s.name + '_favicon.ico'" alt=""/>
                  </a>
                </span>
              </td>

              <td><button class="btn btn-xs" @click="delItem(w)">Delete</button></td>

            </tr>
          </template>
        </table>
      </div>
    </div>
  {% endraw %}

    <script>
        new Vue({
            el: "#vueapp",
            data: {
                wlist: {{ watchlist|safe }},
                {% if (user['prefs'] is defined) and (user['prefs']['hideBlankLines'] is defined) %}
                    hideBlankLines: {{ user['prefs']['hideBlankLines'] | tojson }},
                    hideAmzPayIcons: {{ user['prefs']['hideAmzPayIcons'] | tojson }}
                {% else %}  // ensure py var exists before attempt to convert to json
                    hideBlankLines: true,
                    hideAmzPayIcons: true
                {% endif %}
            },
            methods: {
                sourceClasses: function(w) {
                    return {
                        noSource: (w.sources.length == 0),
                        noSubSource: ((w.sources.length == 1) && (w.sources[0].name == 'amazon_pay'))
                    }
                },
                hideShowListItems: function() {
                    // send post to api to update user prefs
                    this.$http.post('/api/user', {'hideBlankLines': this.hideBlankLines, 'hideAmzPayIcons': this.hideAmzPayIcons});

                    // hide or show amzPay icons
                    if (this.hideAmzPayIcons) {
                        $('.amzPay').css('display', 'none');
                    } else {
                        $('.amzPay').css('display', '');
                    };

                    // hide or show blank lines with no sources
                    if (this.hideBlankLines) {
                        $('.noSource').css('display', 'none');
                        if (this.hideAmzPayIcons) {
                            $('.noSubSource').css('display', 'none');
                        } else {
                            $('.noSubSource').css('display', '');
                        };
                    } else {
                        $('.noSource').css('display', '');
                        $('.noSubSource').css('display', '');
                    };
                },
                delItem: function(w) {
                    this.$http.delete('/api/item/' + w.mtype + '/' + w.id)
                        .then(function(response) {
                            $('.alert').alert('close');  // close any open alerts
                            let index = this.wlist.indexOf(w);
                            if (index > -1) {
                                this.wlist.splice(index, 1);
                            }
                        }, function(error) {
                            $('.alert').alert('close');  // close any open alerts
                            $('#customAlert').html(
                                '<div class="alert alert-danger">Could not delete item</div>'
                            );
                        });
                }
            },
            mounted: function() {  // lifecycle hook for vue instance
                this.hideShowListItems();
            }
        });
    </script>

{% endblock %}
